<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Data Prep &amp; Management | Welcome to the Documentation!</title>
  <meta name="description" content="I love documentation! Don’t you? :)" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Data Prep &amp; Management | Welcome to the Documentation!" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="I love documentation! Don’t you? :)" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Data Prep &amp; Management | Welcome to the Documentation!" />
  
  <meta name="twitter:description" content="I love documentation! Don’t you? :)" />
  

<meta name="author" content="Authors Names Here" />


<meta name="date" content="2019-12-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="vector-data-mapping.html"/>
<link rel="next" href="merging-satellite-and-point-sensor-data.html"/>
<script src="libs/header-attrs-2.3/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>
<link href="libs/leaflet-markercluster-1.0.5/MarkerCluster.css" rel="stylesheet" />
<link href="libs/leaflet-markercluster-1.0.5/MarkerCluster.Default.css" rel="stylesheet" />
<script src="libs/leaflet-markercluster-1.0.5/leaflet.markercluster.js"></script>
<script src="libs/leaflet-markercluster-1.0.5/leaflet.markercluster.freezable.js"></script>
<script src="libs/leaflet-markercluster-1.0.5/leaflet.markercluster.layersupport.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#hello-world"><i class="fa fa-check"></i>Hello World!</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="vector-data-mapping.html"><a href="vector-data-mapping.html"><i class="fa fa-check"></i><b>1</b> Vector Data Mapping</a>
<ul>
<li class="chapter" data-level="1.1" data-path="vector-data-mapping.html"><a href="vector-data-mapping.html#required-packages"><i class="fa fa-check"></i><b>1.1</b> Required Packages</a></li>
<li class="chapter" data-level="1.2" data-path="vector-data-mapping.html"><a href="vector-data-mapping.html#political-boundaries"><i class="fa fa-check"></i><b>1.2</b> Political Boundaries</a></li>
<li class="chapter" data-level="1.3" data-path="vector-data-mapping.html"><a href="vector-data-mapping.html#ground-based-data-sensor-locations"><i class="fa fa-check"></i><b>1.3</b> Ground-based Data Sensor Locations</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="vector-data-mapping.html"><a href="vector-data-mapping.html#epa-particulate-matter-sensors"><i class="fa fa-check"></i><b>1.3.1</b> EPA Particulate Matter Sensors</a></li>
<li class="chapter" data-level="1.3.2" data-path="vector-data-mapping.html"><a href="vector-data-mapping.html#weather-stations"><i class="fa fa-check"></i><b>1.3.2</b> Weather Stations</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="vector-data-mapping.html"><a href="vector-data-mapping.html#point-sources-of-pollution"><i class="fa fa-check"></i><b>1.4</b> Point Sources of Pollution</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-prep-management.html"><a href="data-prep-management.html"><i class="fa fa-check"></i><b>2</b> Data Prep &amp; Management</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-prep-management.html"><a href="data-prep-management.html#epa-pollution-data"><i class="fa fa-check"></i><b>2.1</b> EPA Pollution Data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="data-prep-management.html"><a href="data-prep-management.html#getting-started"><i class="fa fa-check"></i><b>2.1.1</b> Getting Started</a></li>
<li class="chapter" data-level="2.1.2" data-path="data-prep-management.html"><a href="data-prep-management.html#pm2.5-data-query"><i class="fa fa-check"></i><b>2.1.2</b> PM2.5 Data Query</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="data-prep-management.html"><a href="data-prep-management.html#faa-weather-data"><i class="fa fa-check"></i><b>2.2</b> FAA Weather Data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="data-prep-management.html"><a href="data-prep-management.html#sample-query"><i class="fa fa-check"></i><b>2.2.1</b> Sample Query</a></li>
<li class="chapter" data-level="2.2.2" data-path="data-prep-management.html"><a href="data-prep-management.html#finding-asos-sensors"><i class="fa fa-check"></i><b>2.2.2</b> Finding ASOS Sensors</a></li>
<li class="chapter" data-level="2.2.3" data-path="data-prep-management.html"><a href="data-prep-management.html#weather-data-query"><i class="fa fa-check"></i><b>2.2.3</b> Weather Data Query</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="merging-satellite-and-point-sensor-data.html"><a href="merging-satellite-and-point-sensor-data.html"><i class="fa fa-check"></i><b>3</b> Merging Satellite and Point Sensor Data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="merging-satellite-and-point-sensor-data.html"><a href="merging-satellite-and-point-sensor-data.html#generate-rasters"><i class="fa fa-check"></i><b>3.1</b> Generate Rasters</a></li>
<li class="chapter" data-level="3.2" data-path="merging-satellite-and-point-sensor-data.html"><a href="merging-satellite-and-point-sensor-data.html#export-to-csv"><i class="fa fa-check"></i><b>3.2</b> Export to CSV</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Welcome to the Documentation!</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-prep-management" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Data Prep &amp; Management</h1>
<p>This project uses weather and pollution data from remotely sensed satellite imagery, but also ground based sensors maintained by the EPA and FAA to model air quality in the Midwest. Using the ground sensors, the team can attempt to predict pollutions levels based on satellite data. This chapter focuses on how weather and pollution data from ground sensors was downloaded and prepared for use in refining the prediction.</p>
<div id="epa-pollution-data" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> EPA Pollution Data</h2>
<div class="figure"><span id="fig:unnamed-chunk-15"></span>
<img src="https://archive.epa.gov/pesticides/region4/sesd/pm25/web/jpg/air-monitoring-site.jpg" alt="EPA Pollution Monitoring Site (EPA.gov)"  />
<p class="caption">
Figure 2.1: EPA Pollution Monitoring Site (EPA.gov)
</p>
</div>
<p>EPA data was seamlessly imported into R using the <strong>aqsr</strong> package by <a href="https://github.com/jpkeller">Joshua P. Keller</a> at Colorado State University. The package takes advanatge of the <a href="https://aqs.epa.gov/aqsweb/documents/data_mart_welcome.html">EPA AQS DataMart API</a> to load data in R as data.frame objects with only a couple lines of code. It allows users to query for sensor data across multiple air quality variables, geographies, and timeframes. Let’s get started by downloading the package.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="data-prep-management.html#cb21-1" aria-hidden="true"></a><span class="co"># devtools::install_github(&quot;jpkeller/aqsr&quot;)</span></span>
<span id="cb21-2"><a href="data-prep-management.html#cb21-2" aria-hidden="true"></a><span class="kw">library</span>(aqsr)</span></code></pre></div>
<div id="getting-started" class="section level3" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> Getting Started</h3>
<p>This section describes the process for querying EPA sensor data using the <strong>aqsr</strong> package. For more information on how each function works, please reference the package documentation.</p>
<div id="obtaining-an-api-key" class="section level4 unnumbered">
<h4>Obtaining an API Key</h4>
<p>For first time users of the AQS DataMart API, you must first register your email to recieve an API key. (Users who already have a DataMart API key, please skep to the next step). The API key is a required input for all querying functions in the <strong>aqsr</strong> package. Obtaining a key is made simple by calling the <code>aqs_signup()</code> function and inputting your own email address.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="data-prep-management.html#cb22-1" aria-hidden="true"></a><span class="kw">aqs_signup</span>(<span class="st">&#39;YourEmailHere@uchicago.edu&#39;</span>)</span></code></pre></div>
<p>Save your API key from the email confirmation for future reference. In case you don’t recieve an email, verify that your email address was typed correctly, and check your spam folder.</p>
</div>
<div id="using-your-api-key-in-aqsr" class="section level4" number="2.1.1.1">
<h4><span class="header-section-number">2.1.1.1</span> Using your API Key in <strong>aqsr</strong></h4>
<p>Setup your AQI key with the <strong>aqr</strong> package by using the <code>create_user()</code> function. This way, you won’t have to keep typing your email and API key each time you query for data.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="data-prep-management.html#cb23-1" aria-hidden="true"></a>myuser =<span class="st"> </span><span class="kw">create_user</span>(<span class="dt">email =</span> <span class="st">&#39;YourEmailHere@uchicago.edu&#39;</span>, <span class="dt">key =</span> <span class="st">&#39;apikey123&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="pm2.5-data-query" class="section level3" number="2.1.2">
<h3><span class="header-section-number">2.1.2</span> PM2.5 Data Query</h3>
<p>This section describes how to query for PM2.5 concetration data from EPA pollution sensors. We are looking for at PM2.5 data Wisconsin, Illinois, and Indiana between 2014 and 2018 for our project. First, let’s start small and query only for Illinois data for the first week of 2018.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="data-prep-management.html#cb24-1" aria-hidden="true"></a>IL.data =<span class="st"> </span><span class="kw">aqs_dailyData_byState</span>(<span class="dt">aqs_user =</span> myuser,    <span class="co"># Previously defined user emailand API key</span></span>
<span id="cb24-2"><a href="data-prep-management.html#cb24-2" aria-hidden="true"></a>                                <span class="dt">param =</span> <span class="dv">88101</span>,        <span class="co"># EPA AQS Parameter Code for PM2.5</span></span>
<span id="cb24-3"><a href="data-prep-management.html#cb24-3" aria-hidden="true"></a>                                <span class="dt">bdate =</span> <span class="st">&quot;20180101&quot;</span>,   <span class="co"># Starting Date (Jan 1st ,2018)</span></span>
<span id="cb24-4"><a href="data-prep-management.html#cb24-4" aria-hidden="true"></a>                                <span class="dt">edate =</span> <span class="st">&quot;20180107&quot;</span>,   <span class="co"># Ending Date (Jan 7th, 2018)</span></span>
<span id="cb24-5"><a href="data-prep-management.html#cb24-5" aria-hidden="true"></a>                                <span class="dt">state =</span> <span class="st">&quot;17&quot;</span>)         <span class="co"># State FIPS Code for Illinois</span></span></code></pre></div>
<table style="width:100%;">
<colgroup>
<col width="4%" />
<col width="8%" />
<col width="9%" />
<col width="9%" />
<col width="12%" />
<col width="3%" />
<col width="7%" />
<col width="8%" />
<col width="4%" />
<col width="20%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">state_code</th>
<th align="left">county_code</th>
<th align="left">site_number</th>
<th align="left">parameter_code</th>
<th align="right">poc</th>
<th align="right">latitude</th>
<th align="right">longitude</th>
<th align="left">datum</th>
<th align="left">parameter</th>
<th align="left">sample_duration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2</td>
<td align="left">17</td>
<td align="left">111</td>
<td align="left">0001</td>
<td align="left">88101</td>
<td align="right">1</td>
<td align="right">42.22144</td>
<td align="right">-88.24221</td>
<td align="left">WGS84</td>
<td align="left">PM2.5 - Local Conditions</td>
<td align="left">24 HOUR</td>
</tr>
<tr class="even">
<td align="left">2100</td>
<td align="left">17</td>
<td align="left">111</td>
<td align="left">0001</td>
<td align="left">88101</td>
<td align="right">1</td>
<td align="right">42.22144</td>
<td align="right">-88.24221</td>
<td align="left">WGS84</td>
<td align="left">PM2.5 - Local Conditions</td>
<td align="left">24 HOUR</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">17</td>
<td align="left">111</td>
<td align="left">0001</td>
<td align="left">88101</td>
<td align="right">1</td>
<td align="right">42.22144</td>
<td align="right">-88.24221</td>
<td align="left">WGS84</td>
<td align="left">PM2.5 - Local Conditions</td>
<td align="left">24 HOUR</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">17</td>
<td align="left">111</td>
<td align="left">0001</td>
<td align="left">88101</td>
<td align="right">1</td>
<td align="right">42.22144</td>
<td align="right">-88.24221</td>
<td align="left">WGS84</td>
<td align="left">PM2.5 - Local Conditions</td>
<td align="left">24 HOUR</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">17</td>
<td align="left">163</td>
<td align="left">0010</td>
<td align="left">88101</td>
<td align="right">1</td>
<td align="right">38.61203</td>
<td align="right">-90.16048</td>
<td align="left">WGS84</td>
<td align="left">PM2.5 - Local Conditions</td>
<td align="left">24 HOUR</td>
</tr>
</tbody>
</table>
<p>The outputted data frame includes many fields regarding the PM2.5 observation, including spatial data for the sensor’s location. We will focus on these details later on in our data wrangling process. The next code chunk describes how to query for PM2.5 data across our three states and four years.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="data-prep-management.html#cb25-1" aria-hidden="true"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb25-2"><a href="data-prep-management.html#cb25-2" aria-hidden="true"></a></span>
<span id="cb25-3"><a href="data-prep-management.html#cb25-3" aria-hidden="true"></a><span class="co"># List of States to Iterate Through</span></span>
<span id="cb25-4"><a href="data-prep-management.html#cb25-4" aria-hidden="true"></a>states =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;17&quot;</span>, <span class="st">&quot;18&quot;</span>, <span class="st">&quot;55&quot;</span>)</span>
<span id="cb25-5"><a href="data-prep-management.html#cb25-5" aria-hidden="true"></a></span>
<span id="cb25-6"><a href="data-prep-management.html#cb25-6" aria-hidden="true"></a><span class="co"># Matrix of Start Dates and End Dates to Iterate Through</span></span>
<span id="cb25-7"><a href="data-prep-management.html#cb25-7" aria-hidden="true"></a>dates =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="st">&quot;20140101&quot;</span>, <span class="st">&quot;20141231&quot;</span>, <span class="st">&quot;20150101&quot;</span>, <span class="st">&quot;20151231&quot;</span>, <span class="st">&quot;20160101&quot;</span>, <span class="st">&quot;20161231&quot;</span>, <span class="st">&quot;20170101&quot;</span>, <span class="st">&quot;20171231&quot;</span>, <span class="st">&quot;20180101&quot;</span>, <span class="st">&quot;20181231&quot;</span>), <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)</span>
<span id="cb25-8"><a href="data-prep-management.html#cb25-8" aria-hidden="true"></a></span>
<span id="cb25-9"><a href="data-prep-management.html#cb25-9" aria-hidden="true"></a><span class="co"># Leveraging apply functions to iterate through both states and dates</span></span>
<span id="cb25-10"><a href="data-prep-management.html#cb25-10" aria-hidden="true"></a>full.data =<span class="st"> </span><span class="kw">lapply</span>(states, <span class="cf">function</span>(x){</span>
<span id="cb25-11"><a href="data-prep-management.html#cb25-11" aria-hidden="true"></a>                </span>
<span id="cb25-12"><a href="data-prep-management.html#cb25-12" aria-hidden="true"></a>                <span class="kw">mapply</span>(aqs_dailyData_byState, </span>
<span id="cb25-13"><a href="data-prep-management.html#cb25-13" aria-hidden="true"></a>                       <span class="dt">bdate =</span> dates[,<span class="dv">1</span>], </span>
<span id="cb25-14"><a href="data-prep-management.html#cb25-14" aria-hidden="true"></a>                       <span class="dt">edate =</span> dates[,<span class="dv">2</span>], </span>
<span id="cb25-15"><a href="data-prep-management.html#cb25-15" aria-hidden="true"></a>                       <span class="dt">MoreArgs =</span> <span class="kw">list</span>(<span class="dt">aqs_user =</span> myuser, </span>
<span id="cb25-16"><a href="data-prep-management.html#cb25-16" aria-hidden="true"></a>                                       <span class="dt">param =</span> <span class="dv">88101</span>,</span>
<span id="cb25-17"><a href="data-prep-management.html#cb25-17" aria-hidden="true"></a>                                       <span class="dt">state =</span> x),</span>
<span id="cb25-18"><a href="data-prep-management.html#cb25-18" aria-hidden="true"></a>                       <span class="dt">SIMPLIFY =</span> <span class="ot">FALSE</span></span>
<span id="cb25-19"><a href="data-prep-management.html#cb25-19" aria-hidden="true"></a>                       </span>
<span id="cb25-20"><a href="data-prep-management.html#cb25-20" aria-hidden="true"></a>                ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb25-21"><a href="data-prep-management.html#cb25-21" aria-hidden="true"></a><span class="st">                        </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, .)</span>
<span id="cb25-22"><a href="data-prep-management.html#cb25-22" aria-hidden="true"></a>        }) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb25-23"><a href="data-prep-management.html#cb25-23" aria-hidden="true"></a><span class="st">                </span><span class="kw">do.call</span>(<span class="st">&quot;rbind&quot;</span>, .)</span></code></pre></div>
<hr />
</div>
</div>
<div id="faa-weather-data" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> FAA Weather Data</h2>
<div class="figure"><span id="fig:unnamed-chunk-20"></span>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/2008-07-01_Elko_ASOS_viewed_from_the_south_cropped.jpg/1280px-2008-07-01_Elko_ASOS_viewed_from_the_south_cropped.jpg" alt="An ASOS Observation Station in Elko, NV. (Wikimedia Commons)"  />
<p class="caption">
Figure 2.2: An ASOS Observation Station in Elko, NV. (Wikimedia Commons)
</p>
</div>
<p>FAA weather data gathered from the <a href="https://en.wikipedia.org/wiki/Automated_airport_weather_station">Automated Surface Observing System (ASOS)</a> can be imported using the <strong>riem</strong> package. This package, created by <a href="https://ropensci.org/">ROpenSci</a>, queries weather data from the <a href="https://mesonet.agron.iastate.edu/ASOS/">Iowa Environmental Mesonet</a>, an online portal for international ASOS data maintained by Iowa State University. First, let’s load the package.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="data-prep-management.html#cb26-1" aria-hidden="true"></a><span class="co"># devtools::install_github(&#39;ropensci/riem&#39;)</span></span>
<span id="cb26-2"><a href="data-prep-management.html#cb26-2" aria-hidden="true"></a><span class="kw">library</span>(riem, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<div id="sample-query" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Sample Query</h3>
<p>Below is an R code snippet that performs the simplest weather data query possible in the <strong>riem</strong> package. It specifies a particular weather station using an airport code and a date range to query for. The output is a tibble table of raw ASOS weather data. The code snippet below extracts sensor data at the San Francisco International Airport.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="data-prep-management.html#cb27-1" aria-hidden="true"></a>SFO.weather =<span class="st"> </span><span class="kw">riem_measures</span>(<span class="dt">station =</span> <span class="st">&#39;KSFO&#39;</span>, <span class="dt">date_start =</span> <span class="st">&quot;2014-01-01&quot;</span>, <span class="dt">date_end =</span> <span class="st">&#39;2014-01-02&#39;</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">station</th>
<th align="left">valid</th>
<th align="right">tmpf</th>
<th align="right">dwpf</th>
<th align="right">relh</th>
<th align="right">drct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">SFO</td>
<td align="left">2014-01-01 00:56:00</td>
<td align="right">53.96</td>
<td align="right">42.98</td>
<td align="right">66.28</td>
<td align="right">290</td>
</tr>
<tr class="even">
<td align="left">SFO</td>
<td align="left">2014-01-01 01:56:00</td>
<td align="right">51.98</td>
<td align="right">42.98</td>
<td align="right">71.28</td>
<td align="right">280</td>
</tr>
<tr class="odd">
<td align="left">SFO</td>
<td align="left">2014-01-01 02:56:00</td>
<td align="right">51.08</td>
<td align="right">44.06</td>
<td align="right">76.80</td>
<td align="right">290</td>
</tr>
<tr class="even">
<td align="left">SFO</td>
<td align="left">2014-01-01 03:56:00</td>
<td align="right">48.92</td>
<td align="right">37.94</td>
<td align="right">65.67</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">SFO</td>
<td align="left">2014-01-01 04:56:00</td>
<td align="right">50.00</td>
<td align="right">39.92</td>
<td align="right">68.15</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th align="left">station</th>
<th align="left">valid</th>
<th align="right">tmpf</th>
<th align="right">dwpf</th>
<th align="right">alti</th>
<th align="right">vsby</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">SFO</td>
<td align="left">2014-01-01 00:56:00</td>
<td align="right">53.96</td>
<td align="right">42.98</td>
<td align="right">30.16</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">SFO</td>
<td align="left">2014-01-01 01:56:00</td>
<td align="right">51.98</td>
<td align="right">42.98</td>
<td align="right">30.17</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="left">SFO</td>
<td align="left">2014-01-01 02:56:00</td>
<td align="right">51.08</td>
<td align="right">44.06</td>
<td align="right">30.17</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">SFO</td>
<td align="left">2014-01-01 03:56:00</td>
<td align="right">48.92</td>
<td align="right">37.94</td>
<td align="right">30.18</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="left">SFO</td>
<td align="left">2014-01-01 04:56:00</td>
<td align="right">50.00</td>
<td align="right">39.92</td>
<td align="right">30.18</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">SFO</td>
<td align="left">2014-01-01 05:56:00</td>
<td align="right">48.92</td>
<td align="right">37.04</td>
<td align="right">30.19</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
<p>The outputted table shows weather data for a 24-hour period on January 1st, 2014 at the San Francisco International Airport. The <code>valid</code> column species when each weather report was generated, typically at 1-hour intervals. The <code>tmpf</code> and <code>dwpf</code> columns give the ambient air temperature and dew point in Fahrenheit (ºF). Other important variables in our project include air pressure (<code>alti</code>), measured in inches of mercury (in.Hg), and visibility (<code>vsby</code>) in miles. For more information on all available varibles, see Iowa State’s <a href="https://mesonet.agron.iastate.edu/request/download.phtml">Documentation</a>.</p>
<p>Next, we will apply this function at a large scare across multiple sensors and timescales.</p>
</div>
<div id="finding-asos-sensors" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Finding ASOS Sensors</h3>
<p>The FAA collects weather data at hourly intervals for each meteorological station, with some stations providing half-hour intervals. Even querying for short periods of time can yield large amounts of data. To optimise performance, we want to only query data from stations in our study area.</p>
<div id="finding-sensors-by-state" class="section level4 unnumbered">
<h4>Finding Sensors by State</h4>
<p>In our project, we focus on certain counties in Illinois, Indiana, and Wisconsin, so we are interested in finding the sensors within that study area. The first step is to query the locations of all weather stations in the three states using the <strong>riem</strong> package. In the example below, we query for sensors in the Illinois ASOS sensor network.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="data-prep-management.html#cb28-1" aria-hidden="true"></a>IL.stations =<span class="st"> </span><span class="kw">riem_stations</span>(<span class="dt">network =</span> <span class="st">&#39;IL_ASOS&#39;</span>)</span></code></pre></div>
<pre><code>## No encoding supplied: defaulting to UTF-8.</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">name</th>
<th align="right">lon</th>
<th align="right">lat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ALN</td>
<td align="left">ALTON/ST LOUIS R</td>
<td align="right">-90.04599</td>
<td align="right">38.88992</td>
</tr>
<tr class="even">
<td align="left">BMI</td>
<td align="left">BLOOMINGTON/NORM</td>
<td align="right">-88.91592</td>
<td align="right">40.47711</td>
</tr>
<tr class="odd">
<td align="left">CPS</td>
<td align="left">CAHOKIA/ST LOUIS</td>
<td align="right">-90.15622</td>
<td align="right">38.57073</td>
</tr>
<tr class="even">
<td align="left">CIR</td>
<td align="left">Cairo</td>
<td align="right">-89.21960</td>
<td align="right">37.06470</td>
</tr>
<tr class="odd">
<td align="left">MDH</td>
<td align="left">CARBONDALE/MURPH</td>
<td align="right">-89.25000</td>
<td align="right">37.78000</td>
</tr>
<tr class="even">
<td align="left">CUL</td>
<td align="left">Carmi</td>
<td align="right">-88.12306</td>
<td align="right">38.08948</td>
</tr>
</tbody>
</table>
<p>To query for data across multiple states, we are going the apply the <code>riem_stations</code> function to a list of weather station networks, as shown below.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="data-prep-management.html#cb30-1" aria-hidden="true"></a>networks =<span class="st"> </span><span class="kw">list</span>(<span class="st">&#39;IL_ASOS&#39;</span>, <span class="st">&#39;IN_ASOS&#39;</span>, <span class="st">&#39;WI_ASOS&#39;</span>)</span>
<span id="cb30-2"><a href="data-prep-management.html#cb30-2" aria-hidden="true"></a></span>
<span id="cb30-3"><a href="data-prep-management.html#cb30-3" aria-hidden="true"></a><span class="kw">library</span>(dplyr, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</span>
<span id="cb30-4"><a href="data-prep-management.html#cb30-4" aria-hidden="true"></a>station.locs =<span class="st"> </span><span class="kw">lapply</span>(networks, riem<span class="op">::</span>riem_stations) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb30-5"><a href="data-prep-management.html#cb30-5" aria-hidden="true"></a><span class="st">        </span><span class="kw">do.call</span>(rbind, .) <span class="co"># Creates a single data table as output</span></span></code></pre></div>
<p>Note: You can find a list of state abbreviations by typing <code>state.abb</code> in your R console.</p>
</div>
<div id="converting-latitude-and-longitude-coordinates-to-spatial-data" class="section level4 unnumbered">
<h4>Converting Latitude and Longitude Coordinates to Spatial Data</h4>
<p>The data tables returned by the <strong>riem</strong> package must be converted to spatial data to determine which sensors are located in the study area. Since the lon/lat coordinates are already provided, the data table is easily converted to a spatial <code>sf</code> object.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="data-prep-management.html#cb31-1" aria-hidden="true"></a>station.locs.sf =<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_as_sf</span>(station.locs, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb31-2"><a href="data-prep-management.html#cb31-2" aria-hidden="true"></a></span>
<span id="cb31-3"><a href="data-prep-management.html#cb31-3" aria-hidden="true"></a><span class="co"># Plot stations and study area boundaries to verify that the correct sensors were selected</span></span>
<span id="cb31-4"><a href="data-prep-management.html#cb31-4" aria-hidden="true"></a><span class="kw">plot</span>(station.locs.sf<span class="op">$</span>geometry)</span>
<span id="cb31-5"><a href="data-prep-management.html#cb31-5" aria-hidden="true"></a><span class="kw">plot</span>(sf<span class="op">::</span><span class="kw">st_read</span>(<span class="st">&#39;https://uchicago.box.com/shared/static/uw0srt8nyyjfqo6l0dv07cyskwmv6r50.geojson&#39;</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)<span class="op">$</span>geometry, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/csv.to.spatial-1.png" width="672" /></p>
<p>We plot to results to verify that our query and data conversion process worked correctly. For reference, the boundaires of the study area is outlined in red.</p>
</div>
<div id="selecting-sensors-within-our-study-area" class="section level4 unnumbered">
<h4>Selecting Sensors within our Study Area</h4>
<p>Next, we perform a spatial join to only keep the points located within the boundaries of our study area polygons. The spatial join is completed by the <strong>sf</strong> package, as shown below. For more information regarding spatial joins and spatial predicates, please see <a href="https://gisgeography.com/spatial-join/">this</a> helpful blog post by GISgeography.com.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="data-prep-management.html#cb32-1" aria-hidden="true"></a><span class="co"># Loading study area boundaries</span></span>
<span id="cb32-2"><a href="data-prep-management.html#cb32-2" aria-hidden="true"></a>study.area =<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_read</span>(<span class="st">&#39;https://uchicago.box.com/shared/static/uw0srt8nyyjfqo6l0dv07cyskwmv6r50.geojson&#39;</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</span>
<span id="cb32-3"><a href="data-prep-management.html#cb32-3" aria-hidden="true"></a></span>
<span id="cb32-4"><a href="data-prep-management.html#cb32-4" aria-hidden="true"></a>study.sensors =<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_join</span>(station.locs.sf, study.area, <span class="dt">left =</span> <span class="ot">FALSE</span>)</span>
<span id="cb32-5"><a href="data-prep-management.html#cb32-5" aria-hidden="true"></a></span>
<span id="cb32-6"><a href="data-prep-management.html#cb32-6" aria-hidden="true"></a><span class="co"># Verify Spatial Join by Plotting</span></span>
<span id="cb32-7"><a href="data-prep-management.html#cb32-7" aria-hidden="true"></a><span class="kw">plot</span>(study.area<span class="op">$</span>geometry, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb32-8"><a href="data-prep-management.html#cb32-8" aria-hidden="true"></a><span class="kw">plot</span>(study.sensors<span class="op">$</span>geometry, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb32-9"><a href="data-prep-management.html#cb32-9" aria-hidden="true"></a><span class="kw">title</span>(<span class="st">&#39;Weather Stations Within the Study Area&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/sensor.join-1.png" width="672" /></p>
<p>Now that we have a dataset of which weather stations we are interested in, we can query for the weather data associated with each station.</p>
</div>
</div>
<div id="weather-data-query" class="section level3" number="2.2.3">
<h3><span class="header-section-number">2.2.3</span> Weather Data Query</h3>
<p>Again we use the <code>lapply</code> function in base R to execute the <code>riem_measures</code> function on a list of sensor IDs. This allows us to iteratively query for weather data from each individual sensor in a list. In the code snippet below, we take the study sensors obtained previously and query for a single day’s worth of weather data.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="data-prep-management.html#cb33-1" aria-hidden="true"></a><span class="kw">library</span>(dplyr, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)</span>
<span id="cb33-2"><a href="data-prep-management.html#cb33-2" aria-hidden="true"></a></span>
<span id="cb33-3"><a href="data-prep-management.html#cb33-3" aria-hidden="true"></a>weather.data =<span class="st"> </span><span class="kw">lapply</span>(study.sensors<span class="op">$</span>id, <span class="cf">function</span>(x){riem<span class="op">::</span><span class="kw">riem_measures</span>(x, <span class="dt">date_start =</span> <span class="st">&quot;2014-01-01&quot;</span>, <span class="dt">date_end =</span> <span class="st">&quot;2014-01-02&quot;</span>)}) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb33-4"><a href="data-prep-management.html#cb33-4" aria-hidden="true"></a><span class="st">        </span><span class="kw">do.call</span>(rbind, .) <span class="co"># Creates a single data table as output</span></span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">station</th>
<th align="left">valid</th>
<th align="right">lon</th>
<th align="right">lat</th>
<th align="right">tmpf</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MDW</td>
<td align="left">2014-01-01 00:49:00</td>
<td align="right">-87.7524</td>
<td align="right">41.786</td>
<td align="right">12.20</td>
</tr>
<tr class="even">
<td align="left">MDW</td>
<td align="left">2014-01-01 00:51:00</td>
<td align="right">-87.7524</td>
<td align="right">41.786</td>
<td align="right">12.92</td>
</tr>
<tr class="odd">
<td align="left">MDW</td>
<td align="left">2014-01-01 01:51:00</td>
<td align="right">-87.7524</td>
<td align="right">41.786</td>
<td align="right">12.92</td>
</tr>
<tr class="even">
<td align="left">MDW</td>
<td align="left">2014-01-01 02:27:00</td>
<td align="right">-87.7524</td>
<td align="right">41.786</td>
<td align="right">14.00</td>
</tr>
<tr class="odd">
<td align="left">MDW</td>
<td align="left">2014-01-01 02:51:00</td>
<td align="right">-87.7524</td>
<td align="right">41.786</td>
<td align="right">14.00</td>
</tr>
</tbody>
</table>
<div id="querying-full-weather-dataset" class="section level4 unnumbered">
<h4>Querying Full Weather Dataset</h4>
<p>Use caution when querying for a large amount of data. Data tables can easily become unwieldy after querying for a large number of weather stations across a wide time scale. The code snippet below downloads all ASOS weather data for sensors in our study area from January 1st 2014 to December 31st 2018, which is our study time period. It has approximately 4.8 Million records and takes 6-10 minutes to download.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="data-prep-management.html#cb34-1" aria-hidden="true"></a>weather.data =<span class="st"> </span><span class="kw">lapply</span>(study.sensors<span class="op">$</span>id, <span class="cf">function</span>(x){riem<span class="op">::</span><span class="kw">riem_measures</span>(x, <span class="dt">date_start =</span> <span class="st">&quot;2014-01-01&quot;</span>, <span class="dt">date_end =</span> <span class="st">&quot;2018-12-31&quot;</span>)}) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb34-2"><a href="data-prep-management.html#cb34-2" aria-hidden="true"></a><span class="st">        </span><span class="kw">do.call</span>(rbind, .) <span class="co"># Creates a single data table as output</span></span></code></pre></div>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="vector-data-mapping.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="merging-satellite-and-point-sensor-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
